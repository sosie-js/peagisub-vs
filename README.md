# (P) Aegisub-vs

This is lua the companion for aegisub to retrieve path specifiers as well vapoursynth vars
to be able to setup the aegisub-vs python bridge provided in the [Aegisub forked version
from Arch1t3cht](https://github.com/arch1t3cht/Aegisub/releases) BIG THANKS to @arch1t3cht.
Initially I put the script in ?user/automation/autoload but I need 
to trigger it without aegisub installed as a module from python side.

The [published package can be found on Luarocks](https://luarocks.org/modules/sosie-js/peagisub)

## Run / tests , issues and acknowlegdments

This will generate ?user/vsvars.json containing env of aegisub and
gluing with vapoursynth env defined your vapoursynth.conf

### scite

Open test/test.py or test.lua in [scite](https://scintilla.org/SciTE.html) and press [F5]
you should have either vapoursynth.conf path or its content, autogenerated with a
[Dummy Vapoursynth failback](http://www.vapoursynth.com/doc/installation.html#linux)  
if vapoursynth.conf not found. In this case change tha UserPluginFir and SyStemPluginDir
to match your vapoursynth configuration. I recommend this in linux [discussing it here](https://github.com/arch1t3cht/Aegisub/discussions/147#discussioncomment-10073837) :
the UserpluginDIr path standard be ?user/automation
the SystemPluginDir $prefix/vapoursynth with $prefix=/usr/local on linux avoiding env gaz factories

### aegisub

Copy src/main.lua  as aegisub_vs.lua into your automation folder ?user/automation/autoload
Reload aegisub , you will see an entry "Generate aegisub config file" . The script
is triggered on start , clicking on the entry will show where the vsvars.json was saved.

### others (issues)

Run
  src/test.sh for unix
  src/test.bat for windows

Note it will lock due to lua popen problem when triggered in the shell which does not happens in scite 
there I draw [graphs usages in the doc](https://github.com/sosie-js/peagisub-vs/blob/1.3.0/doc/Usage.md) about it see my post [trigger a luarock's module from python](https://github.com/luarocks/luarocks/issues/1694)

## Requirements

- [Lua](http://www.lua.org), version 5.1 or up
- [LuaRocks](https://luarocks.org), any recent version supporting Lua 5.1 and up, e.g. 3.9

How to get Lua and LuaRocks is in detail covered in [the first article of the Lua series](https://martin-fieber.de/blog/lua-project-setup-with-luarocks/).

- [direnv](https://direnv.net) is optional, but very helpful

## Setup and run

First [install LuaRocks for your OS](https://github.com/luarocks/luarocks/wiki/)
Note : you may not need to compile it from sources as suggested in the wiki on Ubuntu/Debian just do
```shell
sudo apt install lua luarocks
```

As indicated in [the Luarock wiki](https://github.com/luarocks/luarocks/wiki/Using-LuaRocks#user-content-Commandline_tools_and_the_system_path)  an extra step du declared /usr/local in your path should be done if you want lua script accessible globally but here we will add the --local flag to avoid to be annoyed by this

```shell
 luarocks install --local peagisub
```
### Locally with lua as current user with the LuaRocks module 'peagisub' installed 

```shell
eval "$(luarocks path --bin)" && lua -l peagisub -e 'os.exit()'
```

see the [run_luarocks_cmd wrapper](https://github.com/luarocks/luarocks/issues/1694) for python usage in the [doc](doc/Usage.md).

### Locally with direnv from the source package

After cloning the repo and entering the project folder, load the project environment context with `direnv allow`, and install all dependencies.

```shell
direnv allow  # Only needed once
luarocks install --deps-only peagisub-1.0.0-4.rockspec
```

Now you can run any script from the project.

```shell
$ lua src/main.lua
```

### Locally without direnv from the source package

After cloning the repo and entering the project folder install all dependencies.

```shell
luarocks install --deps-only peagisub-1.0.0-4.rockspec
```

When running any script from the project you also need to load the setup module.

```shell
$ lua -lsrc/setup src/main.lua
```

